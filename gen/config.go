package gen

import (
	"github.com/aarondl/opt/omit"
	"github.com/stephenafamo/bob/gen/drivers"
)

// Config for the running of the commands
type Config[ConstraintExtra any] struct {
	// System to use to create null and optional types
	// available options are:
	// - "github.com/aarondl/opt" (default)
	//    * Uses null.Val[T] for optional values
	//    * Uses null.Null[T] for nullable values
	// - "database/sql"
	//    * Uses pointers for optional values
	//	  * Uses sql.Null[T] for nullable values
	TypeSystem string `yaml:"type_system"`
	// Struct tags to generate
	Tags []string `yaml:"tags"`
	// Disable generating factories for models
	NoFactory bool `yaml:"no_factory"`
	// Disable generating go test files
	NoTests bool `yaml:"no_tests"`
	// Disable back referencing in the loaded relationship structs
	NoBackReferencing bool `yaml:"no_back_referencing"`
	// Decides the casing for go structure tag names. camel, title or snake (default snake)
	StructTagCasing string `yaml:"struct_tag_casing"`
	// Relationship struct tag name
	RelationTag string `yaml:"relation_tag"`
	// List of column names that should have tags values set to '-' (ignored during parsing)
	TagIgnore []string `yaml:"tag_ignore"`

	Types         map[string]drivers.Type      `yaml:"types"`         // register custom types
	Aliases       drivers.Aliases              `yaml:"aliases"`       // customize aliases
	Constraints   Constraints[ConstraintExtra] `yaml:"constraints"`   // define additional constraints
	Relationships Relationships                `yaml:"relationships"` // define additional relationships

	Replacements []Replace   `yaml:"replacements"`
	Inflections  Inflections `yaml:"inflections"`

	// Customize the generator name in the top level comment of generated files
	// >>   Code generated by **GENERATOR NAME**. DO NOT EDIT.
	// defaults to "BobGen [driver] [version]"
	Generator string `yaml:"generator"`
}

// Replace replaces a column type with something else
type Replace struct {
	Tables  []string     `yaml:"tables"`
	Match   ColumnFilter `yaml:"match"`
	Replace string       `yaml:"replace"`
}

// ColumnFilter is used to filter columns in the config file.
// It should mirror the fields of drivers.Column
type ColumnFilter struct {
	Name      omit.Val[string] `yaml:"name"`
	DBType    omit.Val[string] `yaml:"db_type"`
	Type      omit.Val[string] `yaml:"type"`
	Default   omit.Val[string] `yaml:"default"`
	Comment   omit.Val[string] `yaml:"comment"`
	Nullable  omit.Val[bool]   `yaml:"nullable"`
	Generated omit.Val[bool]   `yaml:"generated"`
	AutoIncr  omit.Val[bool]   `yaml:"autoincr"`

	// DomainName is the domain type name associated to the column. See here:
	// https://www.postgresql.org/docs/16/extend-type-system.html
	DomainName omit.Val[string] `yaml:"domain_name"`
}

func (f ColumnFilter) IsEmpty() bool {
	return f.Name.IsUnset() &&
		f.DBType.IsUnset() &&
		f.Type.IsUnset() &&
		f.Default.IsUnset() &&
		f.Comment.IsUnset() &&
		f.Nullable.IsUnset() &&
		f.Generated.IsUnset() &&
		f.AutoIncr.IsUnset() &&
		f.DomainName.IsUnset()
}

// Matches determines if a drivers.Column matches all the specified criteria (logical AND).
//
// String fields are matched case-insensitively and by regex.
func (f ColumnFilter) Matches(column drivers.Column) bool {
	// empty filters should not match anything
	if f.IsEmpty() {
		return false
	}

	if val, ok := f.Name.Get(); ok && !matchString(val, column.Name) {
		return false
	}

	if val, ok := f.DBType.Get(); ok && !matchString(val, column.DBType) {
		return false
	}

	if val, ok := f.Type.Get(); ok && !matchString(val, column.Type) {
		return false
	}

	if val, ok := f.Default.Get(); ok && !matchString(val, column.Default) {
		return false
	}

	if val, ok := f.Comment.Get(); ok && !matchString(val, column.Comment) {
		return false
	}

	if val, ok := f.DomainName.Get(); ok && !matchString(val, column.DomainName) {
		return false
	}

	if val, ok := f.Nullable.Get(); ok && val != column.Nullable {
		return false
	}

	if val, ok := f.Generated.Get(); ok && val != column.Generated {
		return false
	}

	if val, ok := f.AutoIncr.Get(); ok && val != column.AutoIncr {
		return false
	}

	// all specified conditions matched
	return true
}

type Inflections struct {
	Plural        map[string]string `yaml:"plural"`
	PluralExact   map[string]string `yaml:"plural_exact"`
	Singular      map[string]string `yaml:"singular"`
	SingularExact map[string]string `yaml:"singular_exact"`
	Irregular     map[string]string `yaml:"irregular"`
}
